/**
 * mux.js
 *
 * Copyright (c) 2015 Brightcove
 * All rights reserved.
 *
 * Parse the internal MP4 structure into an equivalent javascript
 * object.
 */
"use strict";
var mp4Inspector=(function(){ function Y(t,n){for(let e=0;e<n.length;e++){const r=n[e];if(typeof r!="string"&&!Array.isArray(r)){for(const i in r)if(i!=="default"&&!(i in t)){const a=Object.getOwnPropertyDescriptor(r,i);a&&Object.defineProperty(t,i,a.get?a:{enumerable:!0,get:()=>r[i]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}let T=Math.pow(2,32),j=function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e;return n.getBigUint64?(e=n.getBigUint64(0),e<Number.MAX_SAFE_INTEGER?Number(e):e):n.getUint32(0)*T+n.getUint32(4)},m={getUint64:j,MAX_UINT32:T},z=function(t){let n="";return n+=String.fromCharCode(t[0]),n+=String.fromCharCode(t[1]),n+=String.fromCharCode(t[2]),n+=String.fromCharCode(t[3]),n},L=z,B=function(t){return t>>>0},P=function(t){return("00"+t.toString(16)).slice(-2)},S={toUnsigned:B,toHexString:P},N=S.toUnsigned,R=L,M=function t(n,e){let r=[],i,a,s,f,u;if(!e.length)return null;for(i=0;i<n.byteLength;)a=N(n[i]<<24|n[i+1]<<16|n[i+2]<<8|n[i+3]),s=R(n.subarray(i+4,i+8)),f=a>1?i+a:n.byteLength,s===e[0]&&(e.length===1?r.push(n.subarray(i+8,f)):(u=t(n.subarray(i+8,f),e.slice(1)),u.length&&(r=r.concat(u)))),i=f;return r},E=M,h,x;function F(){if(x)return h;x=1;const t=m.getUint64;return h=function(e){let r=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:e[0],flags:new Uint8Array(e.subarray(1,4)),references:[],referenceId:r.getUint32(4),timescale:r.getUint32(8)},a=12;i.version===0?(i.earliestPresentationTime=r.getUint32(a),i.firstOffset=r.getUint32(a+4),a+=8):(i.earliestPresentationTime=t(e.subarray(a)),i.firstOffset=t(e.subarray(a+8)),a+=16),a+=2;let s=r.getUint16(a);for(a+=2;s>0;a+=12,s--)i.references.push({referenceType:(e[a]&128)>>>7,referencedSize:r.getUint32(a)&2147483647,subsegmentDuration:r.getUint32(a+4),startsWithSap:!!(e[a+8]&128),sapType:(e[a+8]&112)>>>4,sapDeltaTime:r.getUint32(a+8)&268435455});return i},h}let w,C;function q(){if(C)return w;C=1;const t=S.toUnsigned,n=m.getUint64;return w=function(r){const i={version:r[0],flags:new Uint8Array(r.subarray(1,4))};return i.version===1?i.baseMediaDecodeTime=n(r.subarray(4)):i.baseMediaDecodeTime=t(r[4]<<24|r[5]<<16|r[6]<<8|r[7]),i},w}let O,I;function H(){return I?O:(I=1,O=function(n){let e=new DataView(n.buffer,n.byteOffset,n.byteLength),r={version:n[0],flags:new Uint8Array(n.subarray(1,4)),trackId:e.getUint32(4)},i=r.flags[2]&1,a=r.flags[2]&2,s=r.flags[2]&8,f=r.flags[2]&16,u=r.flags[2]&32,b=r.flags[0]&65536,U=r.flags[0]&131072,g;return g=8,i&&(g+=4,r.baseDataOffset=e.getUint32(12),g+=4),a&&(r.sampleDescriptionIndex=e.getUint32(g),g+=4),s&&(r.defaultSampleDuration=e.getUint32(g),g+=4),f&&(r.defaultSampleSize=e.getUint32(g),g+=4),u&&(r.defaultSampleFlags=e.getUint32(g)),b&&(r.durationIsEmpty=!0),!i&&U&&(r.baseDataOffsetIsMoof=!0),r},O)}let D,V;function G(){return V?D:(V=1,D=function(n){return{isLeading:(n[0]&12)>>>2,dependsOn:n[0]&3,isDependedOn:(n[1]&192)>>>6,hasRedundancy:(n[1]&48)>>>4,paddingValue:(n[1]&14)>>>1,isNonSyncSample:n[1]&1,degradationPriority:n[2]<<8|n[3]}},D)}let v,k;function W(){if(k)return v;k=1;const t=G();return v=function(e){let r={version:e[0],flags:new Uint8Array(e.subarray(1,4)),samples:[]},i=new DataView(e.buffer,e.byteOffset,e.byteLength),a=r.flags[2]&1,s=r.flags[2]&4,f=r.flags[1]&1,u=r.flags[1]&2,b=r.flags[1]&4,U=r.flags[1]&8,g=i.getUint32(4),o=8,l;for(a&&(r.dataOffset=i.getInt32(o),o+=4),s&&g&&(l={flags:t(e.subarray(o,o+4))},o+=4,f&&(l.duration=i.getUint32(o),o+=4),u&&(l.size=i.getUint32(o),o+=4),U&&(r.version===1?l.compositionTimeOffset=i.getInt32(o):l.compositionTimeOffset=i.getUint32(o),o+=4),r.samples.push(l),g--);g--;)l={},f&&(l.duration=i.getUint32(o),o+=4),u&&(l.size=i.getUint32(o),o+=4),b&&(l.flags=t(e.subarray(o,o+4)),o+=4),U&&(r.version===1?l.compositionTimeOffset=i.getInt32(o):l.compositionTimeOffset=i.getUint32(o),o+=4),r.samples.push(l);return r},v}var X=m,_=X.getUint64,c,A,y=function(t){return new Date(t*1e3-20828448e5)},d=L,J=E,K=function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e=[],r,i;for(r=0;r+4<t.length;r+=i){if(i=n.getUint32(r),r+=4,i<=0){e.push("<span style='color:red;'>MALFORMED DATA</span>");continue}switch(t[r]&31){case 1:e.push("slice_layer_without_partitioning_rbsp");break;case 5:e.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:e.push("sei_rbsp");break;case 7:e.push("seq_parameter_set_rbsp");break;case 8:e.push("pic_parameter_set_rbsp");break;case 9:e.push("access_unit_delimiter_rbsp");break;default:e.push("UNKNOWN NAL - "+t[r]&31);break}}return e},p={avc1:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return{dataReferenceIndex:n.getUint16(6),width:n.getUint16(24),height:n.getUint16(26),horizresolution:n.getUint16(28)+n.getUint16(30)/16,vertresolution:n.getUint16(32)+n.getUint16(34)/16,frameCount:n.getUint16(40),depth:n.getUint16(74),config:c(t.subarray(78,t.byteLength))}},avcC:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={configurationVersion:t[0],avcProfileIndication:t[1],profileCompatibility:t[2],avcLevelIndication:t[3],lengthSizeMinusOne:t[4]&3,sps:[],pps:[]},r=t[5]&31,i,a,s,f;for(s=6,f=0;f<r;f++)a=n.getUint16(s),s+=2,e.sps.push(new Uint8Array(t.subarray(s,s+a))),s+=a;for(i=t[s],s++,f=0;f<i;f++)a=n.getUint16(s),s+=2,e.pps.push(new Uint8Array(t.subarray(s,s+a))),s+=a;return e},btrt:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return{bufferSizeDB:n.getUint32(0),maxBitrate:n.getUint32(4),avgBitrate:n.getUint32(8)}},edts:function(t){return{boxes:c(t)}},elst:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),edits:[]},r=n.getUint32(4),i;for(i=8;r;r--)e.version===0?(e.edits.push({segmentDuration:n.getUint32(i),mediaTime:n.getInt32(i+4),mediaRate:n.getUint16(i+8)+n.getUint16(i+10)/(256*256)}),i+=12):(e.edits.push({segmentDuration:_(t.subarray(i)),mediaTime:_(t.subarray(i+8)),mediaRate:n.getUint16(i+16)+n.getUint16(i+18)/(256*256)}),i+=20);return e},esds:function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),esId:t[6]<<8|t[7],streamPriority:t[8]&31,decoderConfig:{objectProfileIndication:t[11],streamType:t[12]>>>2&63,bufferSize:t[13]<<16|t[14]<<8|t[15],maxBitrate:t[16]<<24|t[17]<<16|t[18]<<8|t[19],avgBitrate:t[20]<<24|t[21]<<16|t[22]<<8|t[23],decoderConfigDescriptor:{tag:t[24],length:t[25],audioObjectType:t[26]>>>3&31,samplingFrequencyIndex:(t[26]&7)<<1|t[27]>>>7&1,channelConfiguration:t[27]>>>3&15}}}},ftyp:function(t){for(var n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={majorBrand:d(t.subarray(0,4)),minorVersion:n.getUint32(4),compatibleBrands:[]},r=8;r<t.byteLength;)e.compatibleBrands.push(d(t.subarray(r,r+4))),r+=4;return e},dinf:function(t){return{boxes:c(t)}},dref:function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),dataReferences:c(t.subarray(8))}},hdlr:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),handlerType:d(t.subarray(8,12)),name:""},r=8;for(r=24;r<t.byteLength;r++){if(t[r]===0){r++;break}e.name+=String.fromCharCode(t[r])}return e.name=decodeURIComponent(escape(e.name)),e},mdat:function(t){return{byteLength:t.byteLength,nals:K(t)}},mdhd:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e=4,r,i={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),language:""};return i.version===1?(e+=4,i.creationTime=y(n.getUint32(e)),e+=8,i.modificationTime=y(n.getUint32(e)),e+=4,i.timescale=n.getUint32(e),e+=8,i.duration=n.getUint32(e)):(i.creationTime=y(n.getUint32(e)),e+=4,i.modificationTime=y(n.getUint32(e)),e+=4,i.timescale=n.getUint32(e),e+=4,i.duration=n.getUint32(e)),e+=4,r=n.getUint16(e),i.language+=String.fromCharCode((r>>10)+96),i.language+=String.fromCharCode(((r&992)>>5)+96),i.language+=String.fromCharCode((r&31)+96),i},mdia:function(t){return{boxes:c(t)}},mfhd:function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),sequenceNumber:t[4]<<24|t[5]<<16|t[6]<<8|t[7]}},minf:function(t){return{boxes:c(t)}},mp4a:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={dataReferenceIndex:n.getUint16(6),channelcount:n.getUint16(16),samplesize:n.getUint16(18),samplerate:n.getUint16(24)+n.getUint16(26)/65536};return t.byteLength>28&&(e.streamDescriptor=c(t.subarray(28))[0]),e},moof:function(t){return{boxes:c(t)}},moov:function(t){return{boxes:c(t)}},mvex:function(t){return{boxes:c(t)}},mvhd:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e=4,r={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4))};return r.version===1?(e+=4,r.creationTime=y(n.getUint32(e)),e+=8,r.modificationTime=y(n.getUint32(e)),e+=4,r.timescale=n.getUint32(e),e+=8,r.duration=n.getUint32(e)):(r.creationTime=y(n.getUint32(e)),e+=4,r.modificationTime=y(n.getUint32(e)),e+=4,r.timescale=n.getUint32(e),e+=4,r.duration=n.getUint32(e)),e+=4,r.rate=n.getUint16(e)+n.getUint16(e+2)/16,e+=4,r.volume=n.getUint8(e)+n.getUint8(e+1)/8,e+=2,e+=2,e+=2*4,r.matrix=new Uint32Array(t.subarray(e,e+9*4)),e+=9*4,e+=6*4,r.nextTrackId=n.getUint32(e),r},pdin:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return{version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),rate:n.getUint32(4),initialDelay:n.getUint32(8)}},sdtp:function(t){let n={version:t[0],flags:new Uint8Array(t.subarray(1,4)),samples:[]},e;for(e=4;e<t.byteLength;e++)n.samples.push({dependsOn:(t[e]&48)>>4,isDependedOn:(t[e]&12)>>2,hasRedundancy:t[e]&3});return n},sidx:F(),smhd:function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),balance:t[4]+t[5]/256}},stbl:function(t){return{boxes:c(t)}},ctts:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),compositionOffsets:[]},r=n.getUint32(4),i;for(i=8;r;i+=8,r--)e.compositionOffsets.push({sampleCount:n.getUint32(i),sampleOffset:n[e.version===0?"getUint32":"getInt32"](i+4)});return e},stss:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4)),syncSamples:[]},r=n.getUint32(4),i;for(i=8;r;i+=4,r--)e.syncSamples.push(n.getUint32(i));return e},stco:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:t[0],flags:new Uint8Array(t.subarray(1,4)),chunkOffsets:[]},r=n.getUint32(4),i;for(i=8;r;i+=4,r--)e.chunkOffsets.push(n.getUint32(i));return e},stsc:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e=n.getUint32(4),r={version:t[0],flags:new Uint8Array(t.subarray(1,4)),sampleToChunks:[]},i;for(i=8;e;i+=12,e--)r.sampleToChunks.push({firstChunk:n.getUint32(i),samplesPerChunk:n.getUint32(i+4),sampleDescriptionIndex:n.getUint32(i+8)});return r},stsd:function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),sampleDescriptions:c(t.subarray(8))}},stsz:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:t[0],flags:new Uint8Array(t.subarray(1,4)),sampleSize:n.getUint32(4),entries:[]},r;for(r=12;r<t.byteLength;r+=4)e.entries.push(n.getUint32(r));return e},stts:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e={version:t[0],flags:new Uint8Array(t.subarray(1,4)),timeToSamples:[]},r=n.getUint32(4),i;for(i=8;r;i+=8,r--)e.timeToSamples.push({sampleCount:n.getUint32(i),sampleDelta:n.getUint32(i+4)});return e},styp:function(t){return p.ftyp(t)},tfdt:q(),tfhd:H(),tkhd:function(t){let n=new DataView(t.buffer,t.byteOffset,t.byteLength),e=4,r={version:n.getUint8(0),flags:new Uint8Array(t.subarray(1,4))};return r.version===1?(e+=4,r.creationTime=y(n.getUint32(e)),e+=8,r.modificationTime=y(n.getUint32(e)),e+=4,r.trackId=n.getUint32(e),e+=4,e+=8,r.duration=n.getUint32(e)):(r.creationTime=y(n.getUint32(e)),e+=4,r.modificationTime=y(n.getUint32(e)),e+=4,r.trackId=n.getUint32(e),e+=4,e+=4,r.duration=n.getUint32(e)),e+=4,e+=2*4,r.layer=n.getUint16(e),e+=2,r.alternateGroup=n.getUint16(e),e+=2,r.volume=n.getUint8(e)+n.getUint8(e+1)/8,e+=2,e+=2,r.matrix=new Uint32Array(t.subarray(e,e+9*4)),e+=9*4,r.width=n.getUint16(e)+n.getUint16(e+2)/65536,e+=4,r.height=n.getUint16(e)+n.getUint16(e+2)/65536,r},traf:function(t){return{boxes:c(t)}},trak:function(t){return{boxes:c(t)}},trex:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),trackId:n.getUint32(4),defaultSampleDescriptionIndex:n.getUint32(8),defaultSampleDuration:n.getUint32(12),defaultSampleSize:n.getUint32(16),sampleDependsOn:t[20]&3,sampleIsDependedOn:(t[21]&192)>>6,sampleHasRedundancy:(t[21]&48)>>4,samplePaddingValue:(t[21]&14)>>1,sampleIsDifferenceSample:!!(t[21]&1),sampleDegradationPriority:n.getUint16(22)}},trun:W(),"url ":function(t){return{version:t[0],flags:new Uint8Array(t.subarray(1,4))}},vmhd:function(t){const n=new DataView(t.buffer,t.byteOffset,t.byteLength);return{version:t[0],flags:new Uint8Array(t.subarray(1,4)),graphicsmode:n.getUint16(4),opcolor:new Uint16Array([n.getUint16(6),n.getUint16(8),n.getUint16(10)])}}};c=function(t){var n=0,e=[],r,i,a,s,f;for(r=new DataView(t.buffer, t.byteOffset, t.byteLength);n<t.byteLength;)i=r.getUint32(n),a=d(t.subarray(n+4,n+8)),s=i>1?n+i:t.byteLength,f=(p[a]||function(g){return{data:g}})(t.subarray(n+8,s)),f.size=i,f.type=a,e.push(f),n=s;return e},A=function(t,n){let e;return n=n||0,e=new Array(n*2+1).join(" "),t.map(function(r,i){return e+r.type+`
`+Object.keys(r).filter(function(a){return a!=="type"&&a!=="boxes"}).map(function(a){const s=e+"  "+a+": ",f=r[a];if(f instanceof Uint8Array||f instanceof Uint32Array){const u=Array.prototype.slice.call(new Uint8Array(f.buffer,f.byteOffset,f.byteLength)).map(function(b){return" "+("00"+b.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);return u?u.length===1?s+"<"+u.join("").slice(1)+">":s+`<
`+u.map(function(b){return e+"  "+b}).join(`
`)+`
`+e+"  >":s+"<>"}return s+JSON.stringify(f,null,2).split(`
`).map(function(u,b){return b===0?u:e+"  "+u}).join(`
`)}).join(`
`)+(r.boxes?`
`+A(r.boxes,n+1):"")}).join(`
`)
};return {inspect:c,textify:A,parseType:d,findBox:J,parseTraf:p.traf,parseTfdt:p.tfdt,parseHdlr:p.hdlr,parseTfhd:p.tfhd,parseTrun:p.trun,parseSidx:p.sidx};})();
